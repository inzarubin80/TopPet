# ТЗ: TopPet — конкурсы красоты животных

## 1) Термины
- **Конкурс (Contest)**: сущность, объединяющая участников, голосование, чат.
- **Участник (Participant / AnimalCard)**: карточка животного в рамках конкретного конкурса.
- **Голос (Vote)**: выбор пользователя в рамках конкурса (один на конкурс, действует последнее нажатие).
- **Комментарий (Comment)**: комментарий под карточкой участника.
- **Чат конкурса (ContestChat)**: общий чат в рамках конкурса.
- **Гость**: неавторизованный пользователь.
- **Пользователь**: авторизованный пользователь.
- **Админ конкурса**: пользователь, создавший конкурс.

## 2) Общие требования
- **Просмотр** конкурсов/участников/медиа/комментариев/истории чата не требует авторизации.
- **Любые изменения данных** (создание/редактирование/удаление) и **голосование** требуют авторизации.
- **Стек**:
  - Server: Golang.
  - Client: React.
  - DB: Postgres.
  - Работа с DB: SQLC.
  - Миграции: goose.
  - **FK в БД не используем** (целостность контролируем на уровне service).
  - Медиа: S3-совместимое Object Storage (Yandex Object Storage) + CDN base URL.
  - Чат: WebSocket hub + хранение истории в Postgres.
- **Ориентир реализации слоев/авторизации/S3/WS**: GreenWarden Server: `https://github.com/inzarubin80/GreenWarden/tree/main/Server`.

## 3) Жизненный цикл конкурса
Статусы:
- `draft`: черновик. Доступен публично для просмотра (опционально можно скрывать, но в MVP — публичен), **голосование запрещено**.
- `published`: опубликован. **Голосование разрешено**.
- `finished`: завершён. **Голосование запрещено**.

Переходы:
- `draft -> published`: только админ конкурса.
- `published -> finished`: только админ конкурса (и/или автоматически по дедлайну, если добавим).

## 4) Участники
- Пользователь может добавить карточку животного в конкурс:
  - В MVP: 1 карточка на пользователя на конкурс (уникальность по `(contest_id, user_id)`).
  - Карточка содержит: `pet_name`, `pet_description`.
  - Медиа: 0..N фото, 0..1 видео (в MVP фиксируем 0..1, расширяемо).
- Изменение карточки разрешено владельцу карточки и админ-конкурса (опционально), при условии, что конкурс не `finished`.

## 5) Голосование
- Пользователь может проголосовать за участника **только один раз в рамках конкурса**.
- При повторном выборе — учитывается **последний** выбор (upsert).
- Голосование доступно только для `published`.

### Ограничение видимости результатов
- Публично **не показываем рейтинг/расклад** по участникам.
- Пользователь видит:
  - свой текущий выбор (если авторизован),
  - агрегаты (например, `total_votes` у конкурса и/или у карточки без распределения).

## 6) Комментарии под карточкой
- Комментарии доступны всем для чтения.
- Писать комментарии могут только авторизованные пользователи.
- Редактирование/удаление: только автор комментария (модерация админом конкурса — опционально, можно добавить позже).

## 7) Чат конкурса
- Чат существует у каждого конкурса.
- Чтение истории доступно гостям.
- Отправка сообщений — только авторизованным.
- Реалтайм доставка новых сообщений: WebSocket.
- История хранится в Postgres с пагинацией.

## 8) Авторизация
- Access JWT (короткий TTL) + Refresh token (длинный TTL) по подходу GreenWarden.
- Auth required для всех mutating endpoints.
- Для WebSocket допускаем авторизацию через `Authorization: Bearer ...` или query `accessToken=...` (как в GreenWarden middleware).

## 9) Нефункциональные требования (MVP)
- Валидация входных данных (минимальные проверки: required, max length).
- Пагинация списков: конкурсы, комментарии, чат.
- Логи запросов на сервере.
- CORS на dev и whitelist в prod.

