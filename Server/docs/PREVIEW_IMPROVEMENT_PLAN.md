# План улучшения превью конкурса и участника (на основе тестов)

Основа: результаты тестирования в [TESTING_PREVIEW_RESULTS.md](TESTING_PREVIEW_RESULTS.md) и автотесты в `internal/app/http/meta_html_test.go`.

---

## Приоритет 1: SEO и единообразие конкурса с участником

### 1.1 Обрезка og:title и og:description для конкурса

**Проблема:** В конкурсе заголовок и описание не ограничены по длине; тесты фиксируют риск превышения 60/160 символов.

**Действия:**

- В [meta_html.go](Server/internal/app/http/meta_html.go) в `ServeContest`:
  - Формировать `pageTitle` как `truncateRunes(contest.Title + " - Top-Pet", ogTitleMaxRunes)` (60 символов).
  - Формировать описание: одна строка из `contest.Description` (или `contest.Title` если пусто) + суффикс « Добавляйте своих питомцев»; обрезать до 160 символов (аналогично `participantDescription`). Добавить вспомогательную функцию `contestDescription(contestTitle, contestDesc string) string`.
- В тестах [meta_html_test.go](Server/internal/app/http/meta_html_test.go): добавить проверки, что у конкурса `og:title` ≤ 60 и `og:description` ≤ 160 (при длинных входных данных).

**Критерий готовности:** Тесты на лимиты для конкурса проходят; в чек-листе «og:title до ~60» и «og:description до ~160» для конкурса — OK.

---

### 1.2 og:locale и og:image:alt для конкурса

**Проблема:** У участника выводятся `og:locale` (ru_RU) и `og:image:alt`; у конкурса — нет.

**Действия:**

- В `ServeContest` вызывать `buildMetaTags(..., imageAlt, locale)` с непустыми значениями:
  - `imageAlt` — например «Превью конкурса: » + contest.Title (или «Конкурс Top-Pet» при пустом названии), обрезать при необходимости.
  - `locale` — `"ru_RU"`.
- В тестах: проверять наличие `og:locale` и `og:image:alt` в HTML ответа конкурса.

**Критерий готовности:** Чек-лист: конкурс — OK по og:locale и og:image:alt.

---

### 1.3 Карточка превью для конкурса (дизайн при открытии ссылки)

**Проблема:** У конкурса блок `#og-preview` содержит только картинку; у участника — карточка (фото + заголовок + описание). Непоследовательный UX.

**Действия:**

- Добавить функцию `injectContestPreviewCard(htmlBytes, imageURL, title, description string)` по аналогии с `injectParticipantPreviewCard`: вставка после `<body>` блока с изображением, заголовком (h1) и описанием (p), те же или похожие inline-стили (карточка, скругления).
- В `ServeContest` после `injectMetaIntoHTML` вызывать `injectContestPreviewCard(out, imageURL, pageTitle, description)` вместо `injectPreviewImage`.
- В тестах: для конкурса проверять наличие в `#og-preview` элементов `<h1` и `<p` (карточка с текстом).

**Критерий готовности:** При открытии ссылки на конкурс отображается карточка с заголовком и описанием; тесты обновлены и проходят.

---

## Приоритет 2: Изображения

### 2.1 Растровый fallback вместо SVG для конкурса

**Проблема:** При отсутствии участников используется `baseURL/icon.svg`. SVG для og:image не везде поддерживается (например, Facebook).

**Действия:**

- Добавить в клиент (например, `client/public/`) растровый файл-заглушку для превью: `og-default.png` (рекомендуемый размер 1200×630 или минимум 600×315), либо использовать существующую иконку в PNG.
- В конфиге или в [meta_html.go](Server/internal/app/http/meta_html.go): ввести понятие «дефолтный OG-образ» (например, `BASE_URL/og-default.png` или путь из env `OG_DEFAULT_IMAGE_URL`). В `defaultImageURL()` возвращать этот URL вместо `baseURL + "/icon.svg"`.
- Опционально: в тестах проверять, что дефолтный URL не заканчивается на `.svg` (или проверять значение из конфига).

**Критерий готовности:** При пустом списке участников в meta подставляется URL PNG/JPEG; при необходимости — проверка в Facebook Debugger.

---

### 2.2 og:image:width, og:image:height, og:image:secure_url (опционально)

**Проблема:** В тестах и чек-листе зафиксировано: width/height и secure_url не выводятся.

**Действия:**

- Расширить `buildMetaTags` (или отдельную сборку тегов): опционально принимать параметры `imageWidth`, `imageHeight`, `imageSecureURL`. Если передан HTTPS-URL, выводить `og:image:secure_url`. Если известны размеры (например, для дефолтной картинки 1200×630) — выводить `og:image:width` и `og:image:height`.
- Для пользовательских фото с Yandex Cloud размеры по умолчанию неизвестны; можно выводить width/height только для дефолтного изображения или не выводить до появления генерации превью (см. п. 2.3).

**Критерий готовности:** Для дефолтного изображения (и при наличии данных) в head есть og:image:width, og:image:height и при необходимости og:image:secure_url; тесты при необходимости обновлены.

---

### 2.3 Генерация превью-изображения 1200×630 (отдельная задача)

**Проблема:** Рекомендуемый размер для платформ — 1200×630; пользовательские фото произвольного размера.

**Действия:** Вынести в отдельный план/задачу: генерация на бэкенде (или в хранилище) превью-копии изображения в 1200×630 и использование этого URL в og:image; при реализации подключать вывод og:image:width/height из п. 2.2.

---

## Приоритет 3: SEO

### 3.1 Канонический URL

**Проблема:** В тестах/чек-листе отмечено: `link rel="canonical"` не выводится.

**Действия:**

- В [meta_html.go](Server/internal/app/http/meta_html.go) при сборке head добавлять `<link rel="canonical" href="` + canonicalURL + `">` для страниц конкурса и участника (canonicalURL совпадает с og:url — текущий URL страницы).
- Вставить canonical после `<title>` или в конец head (при инъекции meta). Учесть, что index.html читается из файла — вставка тега в head (например, рядом с meta) через замену строки или шаблон.
- В тестах: проверять наличие подстроки `rel="canonical"` и ожидаемый URL в ответе.

**Критерий готовности:** В HTML превью конкурса и участника есть корректный `<link rel="canonical">`; тесты обновлены.

---

## Порядок внедрения

1. **1.1** — обрезка title/description для конкурса + тесты.  
2. **1.2** — og:locale и og:image:alt для конкурса + тесты.  
3. **1.3** — карточка превью для конкурса + тесты.  
4. **2.1** — растровый fallback вместо SVG (и при необходимости 2.2).  
5. **3.1** — canonical URL.  
6. **2.2** — по необходимости; **2.3** — отдельной задачей.

После каждого пункта — прогон `go test ./internal/app/http` и при необходимости обновление [TESTING_PREVIEW_RESULTS.md](TESTING_PREVIEW_RESULTS.md) (чек-лист и недостатки).
