# Нагрузочное тестирование (k6)

Сценарии нагрузочного тестирования для top-pet.ru и api.top-pet.ru. Инструмент — [k6](https://k6.io/) (Grafana Labs).

## Установка k6

**Linux (бинарник):**
```bash
# Пример для x64
sudo gpg -k
sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6
```

**macOS (Homebrew):**
```bash
brew install k6
```

**Windows / прочие:** см. [официальную документацию](https://k6.io/docs/get-started/installation/).

Проверка: `k6 version`.

## Скрипты

| Файл | Назначение |
|------|------------|
| `k6-api.js` | API: ping, список конкурсов, конкурс по ID, участник по ID. |
| `k6-frontend.js` | Фронт: главная, страница конкурса, страница участника; сценарий «типичный визит» (главная → конкурс → участник). |
| `k6-scenario-contest-flow.js` | Цепочка API: конкурс + список участников; участник + комментарии (имитация загрузки страниц). |
| `k6-ramp-up.js` | Ступенчатый рост нагрузки (30 → 1000 VU) для оценки ёмкости: сколько одновременных посетителей выдержит сайт. |

ID по умолчанию (можно переопределить переменными окружения):

- Конкурс: `f4ba61d5-9ce4-411a-a533-2e90c4e1e3eb`
- Участник: `ca0f6ed7-41a5-49bb-9c3d-69752c65950e`

## Запуск против прода

**По умолчанию** скрипты обращаются к:

- API: `https://api.top-pet.ru`
- Фронт: `https://top-pet.ru`

Запуск из корня репозитория:

```bash
# API (лёгкая нагрузка: ping, contests, contest, participant)
k6 run load/k6-api.js

# Фронт (главная, конкурс, участник + user journey)
k6 run load/k6-frontend.js

# Цепочка API (конкурс + участники, участник + комментарии)
k6 run load/k6-scenario-contest-flow.js
```

Другой хост (например, тестовый):

```bash
API_BASE=https://api.example.com k6 run load/k6-api.js
FRONT_BASE=https://example.com k6 run load/k6-frontend.js
```

Сохранение отчёта:

```bash
k6 run --out json=load/report.json load/k6-api.js
k6 run --out html=load/report.html load/k6-api.js
```

## Пороги (thresholds)

- **API:** p95 &lt; 1000 ms, доля ошибок &lt; 1%.
- **Фронт:** p95 &lt; 3000 ms (отдача SPA тяжелее), доля ошибок &lt; 1%.

При необходимости ужесточить в `options.thresholds` в скриптах (например, `p(95)<500`).

## Безопасный прогон в проде

1. **Запускать** с локальной машины или отдельного сервера, **не** с хоста, где крутится прод.
2. **Нагрузка:** начать с малой (10–20 VU, 30–60 с), затем при успехе увеличить (50 VU, 1–2 мин). Не стартовать сразу с сотен VU.
3. **Время:** согласовать с командой; первый прогон лучше не в часы пик.
4. **POST и WebSocket** в этих скриптах не используются (только чтение). Голосование, комментарии, чат тестировать отдельно при необходимости.

## Результаты

После прогона k6 выводит в stdout сводку: RPS, latency (avg, p95, p99), error rate. Имеет смысл зафиксировать ключевые цифры (например, в `load/results-example.md` или в README) для сравнения при следующих тестах.

### Оценка одновременных посетителей (ramp-up)

Скрипт `load/k6-ramp-up.js` поднимает нагрузку по ступеням: 30 → … → 500 → 600 → 700 → 800 → 900 → 1000 VU (по 1 мин). Прогон 2026-01-31:

- **До 250 одновременных VU** — 0% ошибок, все проверки пройдены.
- Запросов: ~173 757, RPS ~414, p95 latency ~17 ms.
- Лимит не достигнут: при 250 VU сайт работал стабильно. Скрипт поднимает до 1000 VU; перезапустите тест, чтобы проверить предел.

**Итог:** в тестовом сценарии (API ping + конкурс + страница конкурса в цикле) сайт уверенно выдерживает **не менее 250 одновременных посетителей**. Реальный предел зависит от сервера, сети и смеси сценариев (тяжёлые страницы, WebSocket и т.д.).

Пример формата для фиксации:

- Дата, скрипт, VU, длительность
- RPS (запросов в сек)
- http_req_duration: avg, p95 (ms)
- http_req_failed: rate (%)
