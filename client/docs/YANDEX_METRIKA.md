# Реализация Яндекс.Метрики в проекте Top-Pet

Краткое описание для обращения к эксперту: как подключена Метрика, что уже сделано и что может требовать проверки.

---

## Стек и окружение

- **Клиент:** React (Create React App), SPA с React Router.
- **Раздача:** статика отдаётся через nginx в Docker (порт 3000), перед ним может стоять прокси/платформа (Coolify и т.п.).
- **Домен:** top-pet.ru (фронт), api.top-pet.ru (бэкенд).
- **Счётчик Метрики:** 106546874.

---

## Где и как подключена Метрика

### 1. Пакет и компонент

- Используется пакет **react-yandex-metrika** (YMInitializer + функция `ym`).
- **Файл:** `client/src/components/analytics/YandexMetrika.tsx`
- Компонент рендерит `YMInitializer` с `accounts={[counterId]}` и `options={...}` и внутренний трекер маршрутов.
- Рендерится **внутри** `BrowserRouter` в `App.tsx`, чтобы иметь доступ к `useLocation()`.
- ID счётчика берётся из переменной окружения `REACT_APP_YANDEX_METRIKA_ID` при сборке. Если переменная пустая или не число — компонент ничего не рендерит (return null).

### 2. Загрузка скрипта и инициализация

- Скрипт Метрики подключается пакетом **YMInitializer** при монтировании (один раз).
- В `options` передаются: `clickmap`, `trackLinks`, `accurateTrackBounce`, `webvisor`, `trackHash`, `triggerEvent`.

### 3. Хиты (просмотры страниц)

- Первый хит и хиты при смене маршрута отправляются через `ym('hit', url, { title: document.title, referer: document.referrer })` из пакета.
- Внутренний компонент `YandexMetrikaRouteTracker` по `useLocation()` в `useEffect` при изменении `location.pathname` или `location.search` вызывает `ym('hit', window.location.href, hitOptions())`.
- При первом монтировании тот же `useEffect` отправляет первый просмотр.

### 4. Переменная окружения

- **Имя:** `REACT_APP_YANDEX_METRIKA_ID`.
- **Продакшен:** задаётся в `client/.env.production` (значение `106546874`), подхватывается при `npm run build`.
- В разработке можно оставить пустым — тогда Метрика не инициализируется.

### 5. Content Security Policy (CSP)

**Файл:** `client/nginx.conf` (попадает в образ клиента и отдаёт статику)

В блок `server` добавлен заголовок. **`unsafe-eval` оставлен в script-src:** без него tag.js загружается (200), но при выполнении использует eval и блокируется CSP — запросы к mc.yandex.ru/collect и watch не уходят.

```nginx
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-eval' https://mc.yandex.ru https://yastatic.net; ...";
```

- `script-src`: `'self'`, `'unsafe-eval'`, `https://mc.yandex.ru`, `https://yastatic.net` — без `unsafe-eval` данные Метрики не отправляются.
- `connect-src`, `img-src`, `frame-src`: явно разрешён `https://mc.yandex.ru`.

---

## Что видно в браузере

- В Network видна успешная загрузка скрипта Метрики (tag.js) после загрузки страницы.
- Просмотры отправляются через `ym('hit', url, options)` при первой загрузке и при каждом переходе по маршрутам SPA.
- В консоли логов от компонента нет (в продакшене их не добавляли); при необходимости можно вызвать `ym('reachGoal', 'test')` после импорта `ym` из `react-yandex-metrika` для проверки.

---

## В чём нужна помощь эксперта

1. **Запросы отправки данных в Network**  
   Кроме загрузки `tag.js` в списке запросов не видны явные вызовы к mc.yandex.ru (watch, collect и т.п.). Нужно понять: это ожидаемо (запросы идут в другом виде/с задержкой), или что-то мешает их отправке (CSP, расширения, режим браузера)?

2. **Данные в кабинете Метрики**  
   Подтвердить, приходят ли визиты/просмотры в отчёты при такой реализации (динамическая подгрузка tag.js с `?id=...`, init + hit из React, SPA-переходы через hit при смене location).

3. **Рекомендации по реализации**  
   Есть ли более предпочтительный способ подключения Метрики в SPA (официальный сниппет в index.html, другой порядок init/hit, отказ от unsafe-eval за счёт иного способа загрузки и т.д.) при сохранении работы карты кликов, вебвизора и отслеживания переходов по маршрутам.

---

## Внесённые изменения (по рекомендациям эксперта и переход на пакет)

- **Пакет react-yandex-metrika:** инициализация через `YMInitializer`, хиты через `ym('hit', url, { title, referer })`.
- **init (options):** `clickmap`, `trackLinks`, `accurateTrackBounce`, `webvisor`, `trackHash`, `triggerEvent`.
- **Первый хит и при смене маршрута:** передаётся `{ title: document.title, referer: document.referrer }`.
- **CSP:** см. раздел «Content Security Policy» выше; при ошибке eval в браузере — добавить `'unsafe-eval'` в script-src.

---

## Проверочный чеклист

- **«В реальном времени»** в кабинете Метрики — визиты должны отображаться сразу.
- **Инкогнито:** открыть сайт без расширений, сделать 2–3 перехода по страницам, проверить «В реальном времени».
- **Консоль браузера:** после загрузки страницы можно проверить через глобальный объект Метрики (если доступен) или импортировать `ym` из `react-yandex-metrika` и вызвать `ym('reachGoal', 'test')` — в Network должны появиться запросы к mc.yandex.ru.
- **Вебвизор:** в настройках счётчика включён «Вебвизор»; в разделе «Вебвизор» → «Записи» появляются сессии.
- **Фильтры:** в настройках счётчика проверить вкладку «Фильтры» и опцию «Не учитывать мои визиты» (при необходимости отключить для проверки).

---

## Зависимость

В проекте используется пакет **react-yandex-metrika** (YMInitializer + ym). Официальной React-обёртки у Яндекса нет; при необходимости можно вернуться к кастомной загрузке tag.js и вызовам `window.ym(id, 'init', ...)` / `window.ym(id, 'hit', ...)`.

---

## Файлы для справки

| Назначение              | Путь |
|-------------------------|------|
| Компонент Метрики       | `client/src/components/analytics/YandexMetrika.tsx` |
| Подключение в приложении| `client/src/App.tsx` (импорт и `<YandexMetrika />` внутри `BrowserRouter`) |
| Переменная окружения    | `client/.env.production` — `REACT_APP_YANDEX_METRIKA_ID=106546874` |
| CSP (nginx)             | `client/nginx.conf` — `add_header Content-Security-Policy ...` |
| Документация по env     | `client/README.md` — раздел «Переменные окружения» |

Если эксперту нужны фрагменты кода или точные строки конфигов — их можно взять из указанных файлов.
